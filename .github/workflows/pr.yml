name: Pull Request Checks

on:
  pull_request:
    branches:
      - main

jobs:
  check:
    name: Build and Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup mise
        uses: jdx/mise-action@v2
        with:
          version: 2024.11.0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: provider/go.mod
          cache-dependency-path: provider/go.sum

      - name: Install dependencies
        run: make prepare_local_workspace

      - name: Generate schema
        run: make schema

      - name: Validate schema (optional)
        continue-on-error: true
        run: |
          go install github.com/pulumi/schema-tools@latest
          # Only compare if schema exists in main branch
          if gh api repos/${{ github.repository }}/contents/provider/cmd/pulumi-resource-ibmcloud/schema.json --jq .sha 2>/dev/null; then
            schema-tools compare -r github://api.github.com/mapt-oss -p ibmcloud -o main -n --local-path=provider/cmd/pulumi-resource-ibmcloud/schema.json
          else
            echo "No schema found in main branch - skipping comparison"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build provider
        run: make provider

      - name: Build Go SDK
        run: make generate_go

      - name: Run unit tests
        run: make test_provider
